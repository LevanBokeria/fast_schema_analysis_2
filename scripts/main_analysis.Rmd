---
title: "Schema boards: Analyzing everything"
output:
  html_document:
    number_sections: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Setup: load data, define variables, etc

```{r load-data-define-variables}

rm(list=ls())

source('./scripts/utils/load_all_libraries.R')

qc_filter <- F

source('./scripts/utils/load_transform_data.R')

qc_table <- import('./results/qc_check_sheets/qc_table.csv')

if (qc_filter){
        
        qc_pass_ptp <- qc_table %>%
                filter(!qc_fail_overall) %>%
                select(ptp) %>% .[[1]]
        
        
        data_summary <- data_summary %>%
                filter(ptp %in% qc_pass_ptp)
        long_data <- long_data %>%
                filter(ptp %in% qc_pass_ptp)        
        
}

```

# Plot mouse clicks

```{r mouse-heat-plots, fig.width=15, fig.height=10}

long_data %>%
        filter(block == 2) %>%
        droplevels() %>%
        ggplot(aes(mouse_clientX - left_offset,mouse_clientY - top_offset)) +
        geom_point(alpha=0.3) +
        geom_point(aes(pa_center_x - left_offset,pa_center_y - top_offset),
                   color='red',
                   size=2) +
        # geom_density_2d_filled(alpha = 0.3) +
        facet_grid(ptp~condition) +
        ggtitle('block 2: Mouse click locations relative to PA')

```

# Learning curve plots

## All data, each condition

```{r raw-learning-curves-and-fits, fig.width=13, fig.height=10}


# Plot the fits
fig_each_ptp <- mean_by_rep_long_all_types %>%
        filter(hidden_pa_img_type == 'all',
               border_dist_closest == 'all') %>%
        droplevels() %>%        
        ggplot(aes(x=hidden_pa_img_row_number_across_blocks,
                   y=mouse_error_mean)) +
        geom_vline(xintercept = 4.5, linetype = 'dashed') +
        
        geom_point(alpha=0.5) +
        geom_line(alpha=0.5) +        
        
        facet_grid(ptp~condition) +
        ggtitle(paste('Mouse euclidean distance',sep='')) +
        xlab('Image repetition') +
        ylab('Mouse euclidean distance ') +
        scale_x_continuous(breaks=c(1,2,3,4,5,6,7,8)) +
        scale_y_continuous(breaks=seq(0,250,50)) +
        theme(legend.position = '') +
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

print(fig_each_ptp)

```

## All data, overlaid

```{r learning-curves-across-part, fig.width=5, fig.height=4}

# Plot the fits
fig_each_ptp <- mean_by_rep_long_all_types %>%
        filter(hidden_pa_img_type == 'all',
               border_dist_closest == 'all') %>%
        droplevels() %>%                
        group_by(condition,
                 hidden_pa_img_row_number_across_blocks) %>%
        summarise(n = n(),
                  mouse_error_mean_across_ptp = mean(mouse_error_mean,na.rm = T)) %>% 
        ungroup() %>%
        ggplot(aes(x=hidden_pa_img_row_number_across_blocks,
                   y=mouse_error_mean_across_ptp,
                   color=condition)) +
        geom_point() +
        geom_line() +

        # facet_grid(~condition) +
        ggtitle(paste('Mouse euclidean distance; Across participants',sep='')) +
        xlab('Image repetition') +
        ylab('Mouse euclidean distance ') +
        scale_x_continuous(breaks=c(1,2,3,4,5,6,7,8)) +
        # theme(legend.position = 'top') +
        geom_vline(xintercept = 4.5, linetype = 'dashed') 


print(fig_each_ptp)


```

## Near vs far

```{r landmark-raw-learning-curves-and-fits, fig.width=10, fig.height=12}

# For mouse euclidean distance

fig_each_ptp_lm <- mean_by_rep_long_all_types %>%
        filter(hidden_pa_img_type %in% c('near','far'),
               !condition %in% c('random_locations','no_schema'),
               border_dist_closest == 'all'
               ) %>%
        droplevels() %>%
        
        ggplot(aes(x=hidden_pa_img_row_number_across_blocks,
                   y=mouse_error_mean,
                   group=hidden_pa_img_type,
                   color=hidden_pa_img_type)) +
        geom_point(size=1) +
        geom_line(size=0.5) +

        facet_grid(ptp~condition) +
        ggtitle('Mouse euclidean distance') +
        xlab('Image repetition') +
        ylab('Mouse euclidean distance') +
        scale_x_continuous(breaks=c(1,2,3,4,5,6,7,8)) +
        scale_y_continuous(breaks=seq(0,250,50)) +

        # theme(legend.position = 'top') +
        geom_vline(xintercept = 4.5, linetype = 'dashed') +
        # theme(legend.position = '') +
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())        


print(fig_each_ptp_lm)


```

## Near vs far, overlaid

```{r landmark-raw-learning-curves-and-fits-overlaid, fig.width=8, fig.height=5}

# For mouse euclidean distance

fig_each_ptp_lm <- mean_by_rep_long_all_types %>%
        filter(hidden_pa_img_type %in% c('near','far'),
               !condition %in% c('random_locations','no_schema'),
               border_dist_closest == 'all'
               ) %>%
        droplevels() %>%
        
        group_by(condition,
                 hidden_pa_img_type,
                 hidden_pa_img_row_number_across_blocks) %>%
        summarise(n = n(),
                  mouse_error_mean_across_ptp = mean(mouse_error_mean,na.rm = T)) %>% 
        ungroup() %>%
        ggplot(aes(x=hidden_pa_img_row_number_across_blocks,
                   y=mouse_error_mean_across_ptp,
                   color=condition,
                   linetype=hidden_pa_img_type)) +        
        
        geom_point(size=1) +
        geom_line(size=0.5) +

        ggtitle('Mouse euclidean distance') +
        xlab('Image repetition') +
        ylab('Mouse euclidean distance') +
        scale_x_continuous(breaks=c(1,2,3,4,5,6,7,8)) +
        scale_y_continuous(breaks=seq(0,250,50)) +

        # theme(legend.position = 'top') +
        geom_vline(xintercept = 4.5, linetype = 'dashed') +
        # theme(legend.position = '') +
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())        


print(fig_each_ptp_lm)


```


## Near vs far difference across trials:

```{r near-far-diff-across-reps, fig.width=10, fig.height=7}

fig <- mean_by_rep_long_all_types %>%
        filter(hidden_pa_img_type %in% c('near','far'),
               !condition %in% c('random_locations','no_schema'),
               border_dist_closest == 'all'
               ) %>%
        droplevels() %>%

        pivot_wider(id_cols = c(ptp,
                                counterbalancing,
                                condition,
                                hidden_pa_img_row_number_across_blocks),
                    names_from = hidden_pa_img_type,
                    values_from = mouse_error_mean) %>% 
        mutate(far_minus_near = far - near) %>% 
        
        
        ggplot(aes(x=hidden_pa_img_row_number_across_blocks,
                   y=far_minus_near,
                   color=condition,
                   group=condition)) +        
        
        geom_point(size=1) +
        geom_line(size=0.5) +

        facet_wrap(~ptp) +
        ggtitle('Mouse euclidean distance') +
        xlab('Image repetition') +
        ylab('Mouse euclidean distance') +
        scale_x_continuous(breaks=c(1,2,3,4,5,6,7,8)) +
        scale_y_continuous(breaks=seq(0,250,50)) +

        # theme(legend.position = 'top') +
        geom_vline(xintercept = 4.5, linetype = 'dashed') +
        geom_hline(yintercept = 0, linetype = 'dashed') +
        # theme(legend.position = '') +
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())        


print(fig)


```



# Scatter plots of dependent variables:

## Rough measures: last 2 reps and last 4 reps

```{r plot-rough-measures-overall, fig.width=5, fig.height=4}

sum_stats_each_participant %>%
        filter(new_pa_status == 'both',
               accuracy_type == 'mouse_error',
               border_dist == 'all') %>%
        droplevels() %>%
        ggplot(aes(x=condition,
                   y=last_four_mean)) +
        geom_violin() +
        geom_dotplot(binaxis = 'y',
                     stackdir = 'center',
                     stackratio = 1,
                     dotsize = 1,
                     fill = 'black',
                     alpha = 0.2) +
        geom_line(aes(group=ptp_trunk,
                      color=ptp_trunk)) +
        facet_wrap(~accuracy_type, nrow = 1) +
        stat_summary(fun=mean, geom="point", shape=20, size=5, 
                     color="red", fill="red") + 
        stat_summary(fun.data = mean_cl_normal,
                     geom = "errorbar",size=1,width=0.1,color='red') +
        theme(legend.position = '') +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
        ggtitle('Overall, last 4 reps')

sum_stats_each_participant %>%
        filter(new_pa_status == 'both',
               accuracy_type == 'mouse_error',
               border_dist == 'all') %>%
        droplevels() %>%
        ggplot(aes(x=condition,
                   y=log_last_four_mean)) +
        geom_violin() +
        geom_dotplot(binaxis = 'y',
                     stackdir = 'center',
                     stackratio = 1,
                     dotsize = 1,
                     fill = 'black',
                     alpha = 0.2) +
        geom_line(aes(group=ptp_trunk,
                      color=ptp_trunk)) +
        facet_wrap(~accuracy_type, nrow = 1) +
        stat_summary(fun=mean, geom="point", shape=20, size=5, 
                     color="red", fill="red") + 
        stat_summary(fun.data = mean_cl_normal,
                     geom = "errorbar",size=1,width=0.1,color='red') +
        theme(legend.position = '') +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
        ggtitle('Overall, LOG last 4 reps')

```

### near_pa vs far_pa:

```{r plot-rough-measures-new_pa_status}

# Last 4
sum_stats_each_participant %>%
        filter(new_pa_status != 'both',
               !condition %in% c('random_locations','no_schema'),
               accuracy_type == 'mouse_error',
               border_dist == '3_4') %>%
        droplevels() %>%
        pivot_wider(id_cols = c(ptp_trunk,
                                condition,
                                accuracy_type),
                    names_from = new_pa_status,
                    values_from = last_four_mean) %>% 
        mutate(near_far_diff = near_pa - far_pa ) %>%
        ggplot(aes(x=condition,y=near_far_diff)) +
        geom_violin() +
        # geom_jitter(width = 0.1, alpha = 0.2) +
        geom_dotplot(binaxis='y', stackdir='center',
                     stackratio=1, dotsize=1, fill="black",
                     alpha=0.3) +        
        geom_line(aes(group=ptp_trunk,
                      color=ptp_trunk),
                  alpha = 0.5) +
        stat_summary(fun=mean, geom="point", shape=20, size=5, 
                     color="red", fill="red") +   
        stat_summary(fun.data = mean_cl_normal,
                     geom = "errorbar",size=1,width=0.1,color='red') +        
        facet_wrap(~accuracy_type, nrow = 1) +
        ylab('Diff') + 
        theme(legend.position = '') +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
        ggtitle('Border dist 3_4; Far minus near-PA, last 4') +
        geom_hline(yintercept = 0, linetype = 'dashed')

# Last 4 LOG
sum_stats_each_participant %>%
        filter(new_pa_status != 'both',
               !condition %in% c('random_locations','no_schema'),
               accuracy_type == 'mouse_error',
               border_dist == '3_4') %>%
        droplevels() %>%
        pivot_wider(id_cols = c(ptp_trunk,
                                condition,
                                accuracy_type),
                    names_from = new_pa_status,
                    values_from = log_last_four_mean) %>% 
        mutate(near_far_diff = near_pa - far_pa ) %>%
        ggplot(aes(x=condition,y=near_far_diff)) +
        geom_violin() +
        # geom_jitter(width = 0.1, alpha = 0.2) +
        geom_dotplot(binaxis='y', stackdir='center',
                     stackratio=1, dotsize=1, fill="black",
                     alpha=0.3) +        
        geom_line(aes(group=ptp_trunk,
                      color=ptp_trunk),
                  alpha = 0.5) +
        stat_summary(fun=mean, geom="point", shape=20, size=5, 
                     color="red", fill="red") +   
        stat_summary(fun.data = mean_cl_normal,
                     geom = "errorbar",size=1,width=0.1,color='red') +        
        facet_wrap(~accuracy_type, nrow = 1) +
        ylab('Diff') + 
        theme(legend.position = '') +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
        ggtitle('Border dist 3_4; Far minus near-PA, LOG last 4') +
        geom_hline(yintercept = 0, linetype = 'dashed')
```


